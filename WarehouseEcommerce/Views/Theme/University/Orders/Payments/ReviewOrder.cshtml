@using Ganedata.Core.Entities.Enums
@model Ganedata.Core.Entities.Domain.ReviewOrderViewModel
@{
    ViewBag.Title = "Review Order";
    var address = Model.Cart.ShippmentAddresses.FirstOrDefault(p => p.AddTypeShipping == true);
}

<section class="nb_sec nb_prdlisting_pgsec nb_sec_pb">
    <div class="container">
        <div class="breadCrumbtopsec checkout-process-breadcrum">
            <div class="nb_bread_crumbwrap">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li>></li>
                        <li class="breadcrumb-item">
                            <a href="#">Basket</a>
                        </li>
                    </ol>
                </nav>
            </div>
        </div>
        @if (Model.Cart.WebsiteCartItems != null && Model.Cart.WebsiteCartItems.Any())
        {
            <div class="nb_sec checkconfirmSec">
                @Html.Partial("Payments/_OrderProgressBar", OrderProgressStep.ReviewItems)

                <div class="mb-4 col-12">
                    <div class="row">
                        <div class="col botomBtnsec justify-content-start"><a class="btmbtn sho" href="@Url.Action("List", "Products")">CONTINUE SHOPPING</a></div>
                        <div class="col text-center"><h5 class="font-weight-bold header-ul-center-pink">REVIEW ORDER</h5></div>
                        <div class="col text-right botomBtnsec justify-content-end"><button type="Submit" class="btmbtn pro">PROCEED TO PAYMENT</button></div>
                    </div>
                </div>

                <div class="bg-light p-3">
                    <div class="row">
                        <div class="col">
                            <h6 class="mb-2">Delivery Address <a href="#" id="linkChangeDelAddress" class="text-pink small">@(address==null?"Add": "Change")</a></h6>
                            <div id="pDelAddress">
                                @if (address != null)
                                {
                                    <p>
                                        @Html.Partial("_AddressDetail", address)
                                    </p>
                                }
                                else
                                {
                                    <span>Not available</span>
                                }
                                <a href="#" style="@(address != null?"":"display:none;")" class="text-pink small">Add Delivery instruction</a>
                            </div>
                        </div>
                        <div class="col">
                            <h6 class="mb-2">
                                Billing Address
                                <a href="#" id="linkChangeBillAddress" class="text-pink small link-bill" style="@(address != null?"":"display:none;")">Change</a>
                            </h6>
                            <p id="pBillAddress">
                                @if (address != null)
                                {
                                    @Html.Partial("_AddressDetail", address)
                                }
                                else
                                {
                                    <span>Not available </span>
                                }
                            </p>
                        </div>
                        <div class="col">
                            <h6 class="mb-2">Delivery Options</h6>
                            <div class="mb-3">
                                <div class="d-flex align-items-center">
                                    <input type="radio" name="IsStandardDelivery" id="DeliveryOpt1" @(!Model.IsStandardDelivery ? "checked" : "") /> <label for="DeliveryOpt1">Next Day Delivery &pound;<span>@Model.NextDayDeliveryCost</span></label>
                                </div>
                                <div class="d-flex align-items-center">
                                    <input type="radio" name="IsStandardDelivery" id="DeliveryOpt2" @(Model.IsStandardDelivery ? "checked" : "") /> <label for="DeliveryOpt2">Standard Delivery &pound;<span>@Model.StandardDeliveryCost</span> (2 to 5 working days)</label>
                                </div>
                            </div>
                            <div class="d-flex">
                                <div class="mr-4">
                                    <h6>Total Cost</h6>
                                    <div>(Including delivery charges)</div>
                                </div>

                                <h5 class="text-pink">&pound;@Model.CartTotalAmount</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="clearfix"></div>

            <div class="modal fade basket-modal" id="modalAddress" role="dialog">
                <div class="modal-dialog modal-lg">
                    <!-- Modal content-->
                    <div class="modal-content basket-modal-content">
                        <div class="modal-body pl-3 pr-3">
                            <button type="button" class="close mt-3" data-dismiss="modal">&times;</button>                            
                            <div id="divAddressSection" class="content-add">
                            </div>
                        </div>
                    </div>
                </div>
            </div>            
        }

        <div class="mt-4" id="updateCart">
            @Html.Partial("Payments/_CartItems", Model.Cart)
        </div>

        @if (Model.RelatedProducts != null && Model.RelatedProducts.Any())
        {
            <div class="mt-10">
                <h5 class="text-center font-weight-bold">RELATED PRODUCTS</h5>
                @Html.Partial("~/Views/Theme/University/Products/_RelatedProducts.cshtml", Model.RelatedProducts)
            </div>
        }
    </div>
</section>
<script src="~/Scripts/jquery.validate.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.js"></script>
<script>
    $(function () {
        $("#linkChangeDelAddress,#linkChangeBillAddress").click(function () {            
            startLoading();
            $.ajax({
                url: '@Url.Action("GetAddressForm", "Orders")',
                method: 'get',
                data: { isBillingAddress: $(this).hasClass("link-bill") },
                dataType: 'html',
                success: function (data) {
                    stopLoading();
                    $("#modalAddress").modal("show");
                    $("#divAddressSection").html(data);
                }
            });
            return false;
        });

        $("#modalAddress").on("click", "#btnSaveAddress", function () {
            var modal = $(this).closest(".modal");
            modal.find("#formAddAddress").validate();
            if (modal.find("#formAddAddress").valid()) {
                startLoading();
                $.ajax({
                    url: '@Url.Action("SaveNewAddress", "Orders")',
                    method: 'post',
                    data: modal.find("#formAddAddress").serialize(),
                    dataType: 'html',
                    success: function (data) {
                        stopLoading();
                        modal.find(".content-add:eq(0)").html(data);
                    }
                });
            }
        });

        $("#modalAddress").on("click", "#btnSelectAddress", function (e) {
            e.preventDefault();
            var rb = $(this).closest("#divSavedAddSection").find("input[type='radio']:checked:eq(0)")
            var addId = rb.val();
            if (addId > 0) {
                debugger;
                $(rb.data("isbilling") == "True" ? "#pBillAddress" : "#pDelAddress").html(rb.closest(".card-body").find(".address-det:eq(0)").clone().html());
                $(this).closest(".modal").find("button.close").trigger("click");

                if (rb.data("isbilling") == "True")
                    $("#linkChangeBillAddress").show();
                $("#linkChangeDelAddress").text("Change");
            }
            return false;
        });

        $(".wishlist-prod").click(function () {
            var elem = $(this);
            $.ajax({
                url: '@Url.Action("AddWishListItem", "Products")',
                method: 'post',
                data: { productId: elem.data("prodid") },
                    dataType: 'html',
                    success: function (data) {
                        elem.toggleClass("text-secondary", "text-pink");
                    }
                });
        });
    })
</script>


